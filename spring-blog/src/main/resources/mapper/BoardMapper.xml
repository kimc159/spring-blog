<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//ibatis.apache.org//DTD Mapper 3.0//EN" "http://ibatis.apache.org/dtd/ibatis-3-mapper.dtd">
<mapper namespace="com.project.blog.board.mapper.BoardMapper">
		
	<select id="list" resultType="com.project.blog.board.BoardVO">
		select 
			* 
		from (
			select 
				rownum num,
				b.* 
			from (
				select 
					*  
				from 
					board 
					<include refid="search" /> 
				order by 
					board_group desc,
					board_seq asc
				) b
			)
		 WHERE 
		 	NUM 
	 	BETWEEN #{rowStart} AND #{rowEnd}
	</select>  
	
	<insert id="write" parameterType="com.project.blog.board.BoardVO">
		<selectKey keyProperty="seq" resultType="int" order="BEFORE">
			select 
				board_seq.nextval 
			from
				DUAL
		</selectKey>
		insert into 
			board (
				seq, 
				writer, 
				title, 
				content, 
				board_group, 
				board_seq, 
				board_level
			) 
			values (
				#{seq}, 
				#{writer}, 
				#{title}, 
				#{content}, 
				(select NVL(max(board_group)+1, 0) from board),
				0, 
				0
			)
	</insert> 
	
	<insert id="reply" parameterType="com.project.blog.board.BoardVO">
		<selectKey keyProperty="seq" resultType="int" order="BEFORE">
			select board_seq.nextVal from dual
		</selectKey>
		insert into
			board (
				seq,
				title,
				writer,
				content,
				hit,
				board_group,
				board_seq,
				board_level
			)
		values (
			#{seq},
			#{title},
			#{writer},
			#{content},
			0,
			#{board_group},
			#{board_seq} + 1,
			#{board_level}+1 
		)
			
	</insert>
	
	<update id="replyUp" parameterType="com.project.blog.board.BoardVO">
		update 
			board
		set
			board_seq = board_seq + 1
		where
			board_group = #{board_group}
		and
			board_seq > #{board_seq}
	</update> 
	
	<select id="selectBoard" resultType="com.project.blog.board.BoardVO" parameterType="int">
		select  
			* 
		from 
			board 
		where 
			seq = #{seq}
	</select>
	 
	<update id="updateBoard" parameterType="com.project.blog.board.BoardVO">
		update 
			board 
		set 
			title=#{title}, 
			writer=#{writer}, 
			content=#{content} 
		where 
			seq = #{seq}
	</update>
	
	<delete id="deleteBoard" parameterType="int">
		delete from 
			board 
		where 
			seq = #{seq}
	</delete>
	
	<select id="totalCount" resultType="int">
		select 
			count(*) 
		from 
			board 
		<include refid="search" />
	</select>
	<!-- board 조회수 증가 -->
	<update id="hitUp" parameterType="int">
		update 
			board 
		set 
			hit = hit+1 
		where 
			seq = #{seq}
	</update>
	<!-- board_hit 조회수 증가 ()-->
	<insert id="boardHit" parameterType="hashMap">
		insert into
			board_hit (
				hit_seq,
				hit_writer,
				hit_replyer
			)
		values (
			#{hit_seq},
			#{hit_writer},
			#{hit_replyer}
		)
	</insert>
	<select id="selectHitSeq" parameterType="hashMap" resultType="int">
		select
			count(*)
		from
			board_hit
		where
			hit_seq = #{hit_seq}
		and
			hit_replyer = #{hit_replyer}
	</select>
	
	<sql id="search"> 
		<if test="searchType == ''"></if>
		<if test="searchType == 'all'">
			where 
				title 
			like 
				'%'||#{keyword}||'%' 
			or 
				content like '%'||#{keyword}||'%' 
		</if>
		
		<if test="searchType == 'title'"> 
			where 
				title 
			like 
				'%'||#{keyword}||'%'
		</if>
		
		<if test="searchType == 'content'">
			where 
				content 
			like 
				'%'||#{keyword}||'%' 
		</if>
	</sql>
</mapper>